# PRD: Раздел «мерч» (витрина + бронирование без онлайн-оплаты)

## Цель
Запустить раздел «мерч», где пользователь может просматривать товары, выбирать варианты (цвет/размер), применять одноразовые купоны, добавлять в корзину и оформлять заказ-бронирование с фиксированной ценой. Оплата и выдача — офлайн в клубе по номеру заказа.

## Scope
- Витрина мерча в существующем фронтенде (React/Vite, tailwind). Стили — в духе текущего сайта (стеклянные карточки, неоновые акценты) — дизайн остается на исполнителя.
- Корзина и оформление заказа без онлайн-оплаты.
- Купоны (одноразовые, % или фикс, с датой/лимитом).
- Номера заказов, уведомления клиенту (экран/опционально e-mail) и алерты менеджеру (webhook/Telegram/e-mail).
- Админ-операции: CRUD товаров/вариантов, купоны, просмотр/изменение статусов заказов, отметка «выдано/оплачено офлайн».

### Out of Scope (v1)
- Онлайн-оплата (заложить интерфейс, но не подключать).
- Доставка. Только самовывоз в клубе.
- Многоуровневый склад по точкам (одна точка выдачи).

## Архитектура (рекомендация и альтернативы)
- **Рекомендуемая модель:** Headless commerce SaaS (например, Shopify Storefront/Admin API или аналог с draft/orders API). Плюсы: готовые купоны, варианты, инвентарь, админ-панель; минусы: платформа и лимиты API.
- **Самостоятельный хостинг (альтернатива):** Medusa.js или Saleor/Strapi+e-commerce плагин на Postgres. Плюсы: полный контроль и оффлайн-режим; минусы: поддержка/обновления на себе.
- **API-слой:** обернуть commerce API через серверлес (Cloudflare Worker/Pages Functions или Yandex Function) для:
  - валидации купонов и корзины,
  - создания draft/order (статус reserved/pending_offline_payment),
  - маскировки ключей/секретов,
  - интеграции с нотификациями (Telegram bot/email).

## Функциональные требования
- **Каталог:** категории/тэги, поиск по названию, фильтр по размеру/наличию; цены, старая цена, бейдж «скидка».
- **Варианты:** размеры/цвета с собственным SKU, фото по цвету (если есть).
- **Инвентарь:** резерв уменьшает доступный остаток; отмена/просрочка возвращает остаток.
- **Корзина:** локально (localStorage) + серверная валидация перед оформлением.
- **Купоны:** одноразовые и многоразовые; типы: % скидка, фикс, бесплатная доп.позиция (опционально); ограничения по дате, по сумме, по SKU, по количеству применений; маркировать купон как использованный при создании брони.
- **Оформление:** поля: имя, телефон, e-mail (опционально), комментарий; выбор размера/цвета для каждого SKU; итоговая сумма, скидка, номер заказа; статус `reserved_offline`.
- **Номера заказов:** человекочитаемый код (напр. VNVNC-M-XXXX) + внутренний ID.
- **Уведомления:** экран подтверждения + копия номера (копировать); опционально отправка e-mail; уведомление менеджеру (Telegram webhook/Slack/email).
- **Админ:** базовый CRUD товаров/вариантов/купонов, списки заказов, смена статусов (`reserved_offline` → `picked_up`/`cancelled`), просмотр лога по купонам.

## Пользовательский флоу
1) Каталог → карточка товара → выбрать цвет/размер → в корзину.  
2) Корзина: список позиций, изменение количества, ввод купона, пересчет.  
3) Checkout: контактные данные, подтверждение суммы, создание брони.  
4) Экран успеха: номер заказа, сумма со скидкой, инструкция: «оплата в клубе, покажите номер».  
5) Менеджер получает уведомление и видит бронь в админке.

## Данные/сущности (минимум)
- Product {id, title, description, cover, tags, isActive}
- Variant {id, productId, sku, color, size, price, salePrice?, stock}
- Coupon {code, type (%|fixed), value, maxUses, usedCount, validFrom/To, appliesToSkus?, minAmount?, singleUsePerCustomer?}
- CartLine {variantId, qty, priceAtAdd}
- Order {id, code, status, lines[{variantId, qty, price, discount}], couponCode?, discountValue, total, customer{name, phone, email}, createdAt, expiresAt, pickedUpAt?, cancelledAt?, notes}
- InventoryMovement {variantId, delta, reason, orderId?} (опционально для аудита)

## API контур (через свой серверлес)
- `GET /merch/products?tag=&search=` — витрина (кешируем, CDN).
- `GET /merch/products/:id` — детали + варианты.
- `POST /merch/coupons/validate` — {code, cartLines[]} → {isValid, discount, normalizedTotal, reason}.
- `POST /merch/orders` — {cartLines, couponCode?, customer, comment} → {orderId, code, total, discount}.
- `POST /merch/orders/:id/cancel` — для таймаута/отмены.
- `POST /merch/webhooks/platform` — при смене статуса из headless-платформы (если SaaS).

## Инвентарь и резервы
- При создании заказа: блокируем `qty` (резерв) и уменьшаем доступный остаток.
- TTL резерва (например, 48 часов) → авто-отмена и возврат на склад.
- Админ может отметить «выдано/оплачено» → финальное списание.

## Купоны
- Одноразовые: `maxUses=1` или `singleUsePerCustomer=true` + ключ клиента (телефон+hash).
- Сжигание купона на этапе создания заказа; при авто-отмене — возврат использования.
- Лимит по SKU/категории и минимальной сумме; дата старта/окончания.

## Админ-панель варианты
- Использовать родную админку SaaS (Shopify Admin) — быстрее.
- Или легкая кастом-админка (React) поверх API для заказов/купонов, защищенная Basic Auth + IP allowlist/VPN.

## Интеграции
- **Уведомления менеджеру:** Telegram Bot API webhook или e-mail (SendGrid/Mailersend/Yandex).
- **Хранение медиа:** существующий CDN/Cloudflare R2/Yandex Disk; хранить прямые ссылки в товаре.
- **Аналитика:** event: merch_view, merch_add_to_cart, merch_checkout_start, merch_order_created, coupon_applied/failed; через текущий трекер (можно реюзнуть AnalyticsTracker).

## UX/Frontend (общий контур, без жёстких требований)
- Сетка карточек в стиле галереи: стеклянные карточки, неоновые акценты; hover → быстрый выбор варианта или CTA «в корзину».
- Карточка товара: галерея фото/видео, вариативные превью по цвету, выбор размера (кнопки/чипы), остаток «мало»/«в наличии».
- Корзина: слайд-овер/страница; купон; итого; кнопка «оформить».
- Чекаут: простая форма, акцент на офлайн-оплате; копирование номера заказа.
- Мобильный приоритет (Telegram WebView/iOS Safari): без тяжёлых анимаций на форме/корзине.

## Безопасность и эксплуатация
- Секреты commerce-платформы только на серверлес-слое.
- Rate limiting на create/validate coupon.
- Валидация и пересчет корзины на сервере; цены/скидки не доверять клиенту.
- Логи по заказам/купонным ошибкам; алертинг при 5xx и при недоступности платформы.

## Контент и данные
- Набор демо-товаров для разработчиков; флажок «видимость=off» для предпросмотра.
- SEO: /merch как новая страница; превью-изображения.

## Тайм-ауты и состояния
- Статусы заказа: `reserved_offline` → `picked_up` | `cancelled` | `expired`.
- Фоновый джоб/крон (Cloudflare Scheduled Worker/Yandex Cloud Function) для отмены просроченных броней и освобождения купонов/остатка.

## Чек-лист готовности v1
- Каталог + варианты + фото.
- Создание заказа с купоном, резерв инвентаря.
- Номер заказа и уведомление менеджеру.
- Админ: просмотр заказов, смена статуса, CRUD купонов.
- Отмена/TTL резерва работает.
- Документация по API и интеграциям. 
